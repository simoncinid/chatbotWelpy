<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Welpy Chat Widget</title>

  <!-- Marked.js -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    marked.setOptions({ breaks:true, gfm:true });

    /* renderer per i blocchi di codice */
    const renderer = new marked.Renderer();
    renderer.code = c => `<div class="code-block">${c}</div>`;
    marked.use({ renderer });
  </script>

  <style>
    :root{
      --welpy-green:#32c68a;
      --welpy-light:#e6f6f1;
      --welpy-dark :#26795d;
      --welpy-gray :#f0f0f0;
    }
    body{font-family:'Segoe UI',sans-serif}

    /* ─── toggle ─── */
    #chat-toggle{position:fixed;bottom:20px;right:20px;z-index:999;
      width:60px;height:60px;border-radius:50%;display:flex;justify-content:center;
      align-items:center;background:var(--welpy-green);color:#fff;font-size:28px;
      cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,.2);transition:background .3s}
    #chat-toggle:hover{background:var(--welpy-dark)}

    /* ─── widget ─── */
    #chat-widget{position:fixed;bottom:90px;right:20px;width:340px;height:460px;
      background:#fff;border-radius:16px;display:none;flex-direction:column;
      overflow:hidden;box-shadow:0 6px 24px rgba(0,0,0,.2);z-index:998;
      animation:fadeInUp .3s ease-out}
    @keyframes fadeInUp{from{transform:translateY(20px);opacity:0}
                        to  {transform:translateY(0);opacity:1}}

    /* header */
    #chat-header{background:var(--welpy-green);color:#fff;padding:.9rem;text-align:center;
      font-weight:700;font-size:1.05rem;position:relative}
    #chat-close{position:absolute;top:10px;right:12px;font-size:1.2rem;cursor:pointer}
    #chat-restart{position:absolute;top:10px;left:12px;font-size:1.2rem;cursor:pointer;
      background:rgba(255,255,255,.2);border-radius:50%;width:24px;height:24px;
      display:flex;justify-content:center;align-items:center}

    /* box */
    #chat-box{flex:1;padding:1rem;overflow-y:auto;display:flex;flex-direction:column;
      gap:.6rem;background:var(--welpy-light)}

    /* messaggi */
    .message{max-width:85%;padding:.6rem 1rem;border-radius:1rem;font-size:.95rem;
      line-height:1.3;white-space:pre-line;overflow-x:auto;scrollbar-width:none;
      -ms-overflow-style:none}
    .message::-webkit-scrollbar{display:none}              /* scrollbar invisibile */
    .user{align-self:flex-end;background:var(--welpy-green);color:#fff}
    .bot {align-self:flex-start;background:#fff;color:#333;max-width:100%}

    /* markdown: liste & enfasi */
    .bot ul,.bot ol{margin:.4rem 0;padding-left:1.2rem}
    .bot ul{list-style-type:disc}
    .bot ol{list-style-type:decimal}
    .bot strong{font-weight:700}
    .bot em{font-style:italic}

    /* tabelle allineate */
    .bot table{border-collapse:collapse;margin:.3rem 0;width:100%;min-width:560px}
    .bot th,.bot td{border:1px solid #ccc;padding:.35rem .6rem;text-align:left;
      vertical-align:top;word-break:break-word}
    .bot th{background:var(--welpy-light);font-weight:600}

    /* blink typing */
    .typing{align-self:flex-start;background:#fff;color:#333;border-radius:1rem;
      padding:.6rem 1rem;font-size:.95rem;display:flex;gap:4px;max-width:fit-content}
    .typing span{animation:blink 1.2s infinite;animation-delay:calc(var(--i)*.2s);opacity:.4}
    @keyframes blink{0%,100%{opacity:.2}50%{opacity:1}}

    /* code block */
    .code-block{background:#f7f7f7;border:1px solid #ddd;border-radius:6px;
      padding:.5rem;font-family:Consolas,monospace;font-size:.9rem;white-space:pre-wrap}

    /* input */
    #chat-form{display:flex;border-top:1px solid #ddd}
    #chat-input{flex:1;border:none;padding:.9rem;font-size:1rem;outline:none}
    #chat-send{background:var(--welpy-green);color:#fff;border:none;padding:0 1rem;
      font-size:1.1rem;cursor:pointer}

    /* prompt chip */
    #chat-prompts{padding:.5rem 1rem;display:flex;flex-wrap:wrap;gap:6px;
      background:var(--welpy-light);border-top:1px solid #ccc}
    .prompt{background:var(--welpy-gray);padding:.5rem .9rem;border-radius:20px;
      cursor:pointer;font-size:.9rem;transition:background .2s}
    .prompt:hover{background:var(--welpy-green);color:#fff}

    @media(max-width:420px){#chat-widget{width:95%;right:2.5%}}
  </style>
</head>
<body>

<!-- Toggle -->
<div id="chat-toggle">💬</div>

<!-- Widget -->
<div id="chat-widget">
  <div id="chat-header">Hai bisogno di aiuto?
    <div id="chat-restart" title="Riavvia">⟳</div>
    <div id="chat-close"   title="Chiudi">×</div>
  </div>

  <div id="chat-box"></div>

  <div id="chat-prompts">
    <div class="prompt">Quanto mi servirà per andare in pensione?</div>
    <div class="prompt">Cos'è la pensione integrativa?</div>
    <div class="prompt">Quando potrò andare in pensione?</div>
    <div class="prompt">Come funziona il riscatto della laurea?</div>
  </div>

  <form id="chat-form">
    <input id="chat-input" type="text" placeholder="Scrivi qui..." autocomplete="off" required>
    <button id="chat-send" type="submit">➤</button>
  </form>
</div>

<script>
const toggle   = document.getElementById('chat-toggle');
const widget   = document.getElementById('chat-widget');
const box      = document.getElementById('chat-box');
const prompts  = document.querySelectorAll('.prompt');
const promptBox= document.getElementById('chat-prompts');
const closeBtn = document.getElementById('chat-close');
const restart  = document.getElementById('chat-restart');
const form     = document.getElementById('chat-form');
const input    = document.getElementById('chat-input');

let threadId=null, firstMsg=false;

/* UI helpers */
function appendMessage(text, sender){
  const msg = document.createElement('div');
  msg.className = `message ${sender}`;

  if (sender === 'bot'){
    /* 1. se arriva un oggetto, prova a estrarre markdown */
    if (typeof text === 'object' && text !== null){
      text = text.markdown ?? JSON.stringify(text, null, 2);   // pretty‑print
    }
    /* 2. ora è sicuramente stringa → markdown → html */
    msg.innerHTML = marked.parse(text);
  } else {
    msg.textContent = text;
  }

  box.appendChild(msg);
  box.scrollTop = box.scrollHeight;
}
function showTyping(){
  const t=document.createElement('div');t.className='typing';t.id='typing-indicator';
  for(let i=1;i<=3;i++){const dot=document.createElement('span');dot.textContent='●';
    dot.style.setProperty('--i',i);t.appendChild(dot);}
  box.appendChild(t);box.scrollTop=box.scrollHeight;
}
const removeTyping=()=>document.getElementById('typing-indicator')?.remove();

/* open/close/restart */
toggle.onclick = () => widget.style.display='flex';
closeBtn.onclick= () => widget.style.display='none';
restart.onclick = () => {threadId=null;firstMsg=false;box.innerHTML='';promptBox.style.display='flex';};

/* send */
async function sendMessage(txt){
  appendMessage(txt,'user');
  input.value='';
  if(!firstMsg){firstMsg=true;promptBox.style.display='none';}
  showTyping();
  try{
    const res=await fetch('https://welpy-1.onrender.com/chat',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({message:txt,thread_id:threadId})
    });
    const data=await res.json();threadId=data.thread_id;
    removeTyping();appendMessage(data.response,'bot');
  }catch{
    removeTyping();appendMessage('Errore di connessione. Riprova più tardi.','bot');
  }
}

/* events */
form.onsubmit=e=>{e.preventDefault();const v=input.value.trim();if(v)sendMessage(v);}
prompts.forEach(p=>p.onclick=()=>sendMessage(p.textContent));
</script>

</body>
</html>
