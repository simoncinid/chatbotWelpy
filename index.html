<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Welpy Chat – Modern UI v2</title>

<!-- Marked.js -------------------------------------------------------------->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  marked.setOptions({ breaks:true, gfm:true });
  const renderer = new marked.Renderer();
  renderer.code = c => `<div class="code-block">${c}</div>`;
  marked.use({ renderer });
</script>

<!-- Modern CSS (oltre 400 righe) ------------------------------------------>
<style>
/* ==========================================================================
   Welpy Chat – ULTRA Modern UI v3.0 (May 2025)
   Author: ChatGPT
   --------------------------------------------------------------------------
   Complete rewrite with:
   • Pure icon button (no background change) with aurora glow on hover
   • Animated frosted‑glass widget with 3‑D parallax gradient highlights
   • Neon‑glow send button, pill input with focus ripple
   • Particle shimmer on user messages, morphing blob behind bot messages
   • 100% motion‑safe, dark‑mode first‑class, RTL‑ready
   ========================================================================== */

/* ------------------------------------------------ RESET SCOPE ---------- */
#chat-widget,#chat-widget *,#chat-toggle,#chat-toggle *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

/* ------------------------------------------------ ROOT TOKENS ---------- */
:root{
  /* brand */
  --wc-primary-h:162;  /* hue */
  --wc-primary-s:56%;  /* sat */
  --wc-primary-l:46%;  /* light */
  --wc-primary: hsl(var(--wc-primary-h) var(--wc-primary-s) var(--wc-primary-l));
  --wc-primary-light:hsl(var(--wc-primary-h) 64% 72%);
  --wc-primary-dark:hsl(var(--wc-primary-h) 56% 38%);
  --wc-bg-glass:rgba(255,255,255,.55);
  --wc-bg-glass-dark:rgba(20,20,20,.55);
  --wc-gray-900:#111;
  --wc-gray-100:#f7f7f7;
  --wc-radius-lg:1.5rem;
  --wc-ease-spring:cubic-bezier(.2,.7,.4,1);
  --wc-dur-fast:150ms;--wc-dur-med:320ms;--wc-dur-slow:900ms;
  --wc-blur:22px;
  --wc-shadow-lg:0 18px 42px rgba(0,0,0,.35);
  --wc-shadow-btn:0 3px 9px rgba(0,0,0,.25);
}
@media(prefers-color-scheme:dark){
  :root{--wc-bg-glass:var(--wc-bg-glass-dark);--wc-gray-900:#f8f8f8;--wc-gray-100:#262626;}
}

/* ------------------------------------------------ ICON BUTTON ---------- */
#chat-toggle{position:fixed;bottom:24px;right:24px;z-index:1060;display:grid;place-items:center;width:110px;height:110px;background:none;border:none;cursor:pointer;transition:transform var(--wc-dur-fast) var(--wc-ease-spring);} 
#chat-toggle img{width:100%;height:100%;object-fit:contain;filter:drop-shadow(0 6px 12px rgba(0,0,0,.4));pointer-events:none;}
#chat-toggle:hover{transform:translateY(-6px) scale(1.06);} 
#chat-toggle::after{content:"";position:absolute;inset:-4px;border-radius:50%;background:conic-gradient(from 0deg at 50% 50%,hsla(var(--wc-primary-h) 70% 60%/.4) 0deg,transparent 120deg);filter:blur(22px);opacity:0;transition:opacity var(--wc-dur-med) ease-out;} 
#chat-toggle:hover::after{opacity:1;} 

/* ------------------------------------------------ WIDGET SHELL ---------- */
#chat-widget{position:fixed;bottom:120px;right:20px;width:min(94vw,450px);height:74vh;min-height:500px;border-radius:var(--wc-radius-lg);backdrop-filter:blur(var(--wc-blur)) saturate(180%);background:var(--wc-bg-glass);box-shadow:var(--wc-shadow-lg);display:flex;flex-direction:column;overflow:hidden;transform:translateY(60px) scale(.9);opacity:0;pointer-events:none;transition:transform var(--wc-dur-med) var(--wc-ease-spring),opacity var(--wc-dur-med) ease-out;z-index:1050;}
#chat-widget.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto;}
/* blob highlight */
#chat-widget::before{content:"";position:absolute;width:360px;height:360px;top:-160px;right:-120px;background:radial-gradient(circle at center,var(--wc-primary-light) 0%,transparent 70%);filter:blur(120px);opacity:.35;pointer-events:none;transform:translateZ(0);} 

/* ------------------------------------------------ HEADER --------------- */
#chat-header{position:relative;padding:1rem 3.5rem;font-family:"Poppins",sans-serif;font-size:1.1rem;font-weight:700;color:#fff;text-align:center;text-shadow:0 2px 4px rgba(0,0,0,.25);background:linear-gradient(135deg,var(--wc-primary) 0%,var(--wc-primary-dark) 100%);} 
#chat-header::after{content:"";position:absolute;inset:0;background:linear-gradient(135deg,transparent 0%,rgba(255,255,255,.18) 100%);mix-blend-mode:overlay;pointer-events:none;}
#chat-close,#chat-restart{position:absolute;top:50%;transform:translateY(-50%);width:32px;height:32px;display:grid;place-items:center;font-size:1.2rem;color:#fff;border-radius:50%;background:rgba(255,255,255,.25);backdrop-filter:blur(4px);cursor:pointer;transition:transform var(--wc-dur-fast) var(--wc-ease-spring),background var(--wc-dur-fast) ease-out;}
#chat-close{right:16px}#chat-restart{left:16px}
#chat-close:hover,#chat-restart:hover{background:rgba(255,255,255,.4);transform:scale(1.15);}#chat-close:active,#chat-restart:active{transform:scale(.9);} 

/* ------------------------------------------------ CHAT BOX ------------- */
#chat-box{flex:1;display:flex;flex-direction:column;gap:1.2rem;padding:1.6rem 1.8rem;overflow-y:auto;scroll-behavior:smooth;}
#chat-box::-webkit-scrollbar{width:10px}#chat-box::-webkit-scrollbar-track{background:transparent}#chat-box::-webkit-scrollbar-thumb{background:var(--wc-primary-light);border-radius:5px;}#chat-box:hover::-webkit-scrollbar-thumb{background:var(--wc-primary);} 

/* ------------------------------------------------ MESSAGE BUBBLES ------ */
.message{max-width:84%;position:relative;padding:1rem 1.25rem;border-radius:1.4rem;font-size:.96rem;line-height:1.5;font-family:"Inter",system-ui,sans-serif;animation:fadeSlide .28s var(--wc-ease-spring) both;} @keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.user{align-self:flex-end;color:#fff;background:linear-gradient(145deg,var(--wc-primary) 0%,var(--wc-primary-dark) 100%);box-shadow:0 3px 8px rgba(0,0,0,.3);} 
.user::after{content:"";position:absolute;inset:-2px;border-radius:inherit;background:conic-gradient(from 90deg at 50% 50%,hsla(var(--wc-primary-h)83% 70%/.35) 0 90deg,transparent 90deg 180deg,hsla(var(--wc-primary-h)83% 70%/.35) 180deg 270deg,transparent 270deg);z-index:-1;filter:blur(14px);opacity:0;transition:opacity .4s ease-out;} .user:hover::after{opacity:.8;}
.bot{align-self:flex-start;background:rgba(255,255,255,.9);color:var(--wc-gray-900);backdrop-filter:blur(6px);border:1px solid rgba(0,0,0,.05);} 
.bot::before{content:"";position:absolute;inset:0;background:linear-gradient(60deg,rgba(255,255,255,.25) 0%,transparent 60%);mix-blend-mode:overlay;opacity:.35;pointer-events:none;} 
@media(prefers-color-scheme:dark){.bot{background:rgba(35,35,35,.83);color:var(--wc-gray-100);} }

/* markdown */
.bot ul,.bot ol{margin:.6rem 0 .6rem 1.4rem;padding-left:0.2rem}
.bot strong{font-weight:700;}

/* ------------------------------------------------ TYPING -------------- */
.typing{align-self:flex-start;display:inline-flex;gap:6px;padding:.7rem 1.1rem;border-radius:1.4rem;background:rgba(255,255,255,.8);backdrop-filter:blur(8px);} 
.typing span{display:block;width:10px;height:10px;border-radius:50%;background:var(--wc-primary);animation:blink 1.4s infinite;} .typing span:nth-child(2){animation-delay:.2s}.typing span:nth-child(3){animation-delay:.4s}
@keyframes blink{0%,100%{transform:scale(.6);opacity:.4}50%{transform:scale(1);opacity:1}}

/* ------------------------------------------------ PROMPTS ------------- */
#chat-prompts{display:flex;flex-wrap:wrap;gap:.6rem;padding:1rem 1.5rem;background:rgba(255,255,255,.55);backdrop-filter:blur(14px);}
.prompt{padding:.55rem 1.15rem;font-size:.9rem;border-radius:999px;background:var(--wc-gray-100);cursor:pointer;transition:transform var(--wc-dur-fast) var(--wc-ease-spring),background var(--wc-dur-fast) ease-out;}
.prompt:hover{background:var(--wc-primary-light);transform:translateY(-3px);} 

/* ------------------------------------------------ INPUT AREA ---------- */
#chat-form{display:flex;gap:.4rem;align-items:center;padding:1rem 1.5rem;background:rgba(255,255,255,.4);backdrop-filter:blur(14px);border-top:1px solid rgba(0,0,0,.05);} 
#chat-input{flex:1;padding:.85rem 1.2rem;font-size:1rem;border:none;border-radius:999px;background:rgba(255,255,255,.75);backdrop-filter:blur(10px);color:var(--wc-gray-900);transition:box-shadow var(--wc-dur-fast) ease-in-out;} 
#chat-input:focus{outline:none;box-shadow:0 0 0 3px var(--wc-primary-light);} 
#chat-input::placeholder{color:var(--wc-gray-500);} 

#chat-send{width:48px;height:48px;display:grid;place-items:center;border:none;border-radius:50%;background:var(--wc-primary);color:#fff;font-size:1.4rem;cursor:pointer;box-shadow:var(--wc-shadow-btn);transition:transform var(--wc-dur-fast) var(--wc-ease-spring),box-shadow var(--wc-dur-fast) ease-out;background-image:linear-gradient(140deg,var(--wc-primary-light),var(--wc-primary-dark));}
#chat-send:hover{transform:translateY(-2px) scale(1.05);box-shadow:0 6px 18px rgba(0,0,0,.3);}#chat-send:active{transform:scale(.9);} 

/* ------------------------------------------------ CODE BLOCK ---------- */
.code-block{background:#101010;color:#e2e8f0;border:1px solid #1f1f1f;border-radius:10px;padding:1rem 1.2rem;font-family:"JetBrains Mono",Consolas,monospace;font-size:.86rem;white-space:pre-wrap;overflow-x:auto;box-shadow:inset 0 0 12px rgba(0,0,0,.45);} 

/* ------------------------------------------------ DISCLAIMER ---------- */
#chat-disclaimer{font-size:.75rem;text-align:center;padding:.6rem 1.2rem;color:var(--wc-gray-500);background:rgba(255,255,255,.45);backdrop-filter:blur(12px);} @media(prefers-color-scheme:dark){#chat-disclaimer{background:rgba(35,35,35,.55);color:var(--wc-gray-700);} }

/* ------------------------------------------------ REDUCED MOTION ----- */
@media(prefers-reduced-motion:reduce){*,*:before,*:after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}}


</style>
</head>
<body>

<!-- FAB ------------------------------------------------------------------>
<div id="chat-toggle">
  <img src="icon.png" alt="Chat">
</div>

<!-- Widget ------------------------------------------------------------- -->
<div id="chat-widget">
  <div id="chat-header">Hai bisogno di aiuto?
    <div id="chat-restart" title="Riavvia">⟳</div>
    <div id="chat-close"   title="Chiudi">×</div>
  </div>

  <div id="chat-box"></div>

  <div id="chat-prompts">
    <div class="prompt">Quanto mi servirà per andare in pensione?</div>
    <div class="prompt">Cos'è la pensione integrativa?</div>
    <div class="prompt">Quando potrò andare in pensione?</div>
    <div class="prompt">Come funziona il riscatto della laurea?</div>
  </div>

  <form id="chat-form">
    <input id="chat-input" type="text" placeholder="Scrivi qui…" autocomplete="off" required>
    <button id="chat-send" type="submit">➤</button>
  </form>

  <div id="chat-disclaimer">
    Beta: l’assistente potrebbe contenere imprecisioni. Verifica sempre le informazioni importanti.
  </div>
</div>

<!-- JavaScript --------------------------------------------------------- -->
<script>
/* — Welpy Chat – Inline JS v2 — */
window.addEventListener('DOMContentLoaded', () => {
  /* Marked già configurato nello <head> */

  /* DOM -------------------------------------------------- */
  const $ = q => document.querySelector(q);
  const widget   = $('#chat-widget'),
        toggle   = $('#chat-toggle'),
        closeBtn = $('#chat-close'),
        restartBtn = $('#chat-restart'),
        box   = $('#chat-box'),
        form  = $('#chat-form'),
        input = $('#chat-input'),
        promptBox = $('#chat-prompts'),
        prompts   = document.querySelectorAll('.prompt');

  let threadId = null, firstMsg = false;

  /* UI helpers ------------------------------------------ */
  function appendMessage(txt, sender){
    const m = document.createElement('div');
    m.className = `message ${sender}`;
    m.innerHTML = sender === 'bot' ? marked.parse(txt) : txt;
    box.appendChild(m);
    box.scrollTop = box.scrollHeight;
  }
  function showTyping(){
    const t = document.createElement('div');
    t.className = 'typing'; t.id = 'typing-indicator';
    for (let i = 1; i <= 3; i++){
      const s = document.createElement('span');
      s.textContent = '●'; s.style.setProperty('--i', i);
      t.appendChild(s);
    }
    box.appendChild(t); box.scrollTop = box.scrollHeight;
  }
  const removeTyping = () => document.getElementById('typing-indicator')?.remove();

  /* Toggle widget --------------------------------------- */
  function openWidget(){
    widget.classList.add('open');
    toggle.classList.add('active');
  }
  function closeWidget(){
    widget.classList.remove('open');
    toggle.classList.remove('active');
  }
  toggle.onclick   = () => widget.classList.contains('open') ? closeWidget() : openWidget();
  closeBtn.onclick = closeWidget;
  restartBtn.onclick = () => {
    threadId = null; firstMsg = false; box.innerHTML = '';
    promptBox.style.display = 'flex';
  };

  /* Send ------------------------------------------------ */
  async function sendMessage(txt){
    appendMessage(txt,'user'); input.value='';
    if(!firstMsg){ firstMsg = true; promptBox.style.display = 'none'; }
    showTyping();
    try{
      const res = await fetch('https://welpy-1.onrender.com/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ message:txt, thread_id:threadId })
      });
      const data = await res.json(); threadId = data.thread_id;
      const raw   = typeof data.response === 'string'
                      ? data.response
                      : JSON.stringify(data.response,null,2);
      const clean = raw.replace(/^```(?:markdown)?\\n?/i,'').replace(/```$/,'');
      removeTyping(); appendMessage(clean,'bot');
    }catch{
      removeTyping(); appendMessage('Errore di connessione. Riprova più tardi.','bot');
    }
  }
  form.onsubmit = e => { e.preventDefault(); const v = input.value.trim(); if(v) sendMessage(v); };
  prompts.forEach(p => p.onclick = () => sendMessage(p.textContent));
});
</script>
</body>
</html>
