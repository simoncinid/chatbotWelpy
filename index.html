<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Welpy Chat – Modern UI v2</title>

<!-- Marked.js -------------------------------------------------------------->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  marked.setOptions({ breaks:true, gfm:true });
  const renderer = new marked.Renderer();
  renderer.code = c => `<div class="code-block">${c}</div>`;
  marked.use({ renderer });
</script>

<!-- Modern CSS (oltre 400 righe) ------------------------------------------>
<style>
/* ==========================================================================
   Welpy Chat – Modern UI v2.0  (May 2025)
   ========================================================================== */

/* RESET scoped */
#chat-widget, #chat-widget *{
  box-sizing:border-box;
  -webkit-tap-highlight-color:transparent;
  font-variant-ligatures:common-ligatures;
}

/* TOKENS --------------------------------------------------------------- */
:root{
  --wc-primary-50:#e5fff5;
  --wc-primary-300:#64eeb0;
  --wc-primary-400:#3fe89c;
  --wc-primary-500:#21d184;
  --wc-primary-600:#1ab371;
  --wc-primary-700:#13955f;
  --wc-gray-900:#171717;
  --wc-gray-700:#3d3d3d;
  --wc-gray-500:#6e6e6e;
  --wc-gray-100:#f5f5f5;
  --wc-radius-lg:1.25rem;
  --wc-radius-full:9999px;
  --wc-ease-spring:cubic-bezier(.25,.8,.3,1);
  --wc-dur-fast:120ms;
  --wc-dur-med:280ms;
  --wc-glass-blur:20px;
  --wc-code-bg:#0f0f0f;
  --wc-code-text:#e2e8f0;
}
@media(prefers-color-scheme:dark){
  :root{
    --wc-primary-500:#10b168;
    --wc-primary-600:#31c786;
    --wc-primary-700:#5cd7a1;
    --wc-gray-900:#f8f9fa;
    --wc-gray-700:#d1d5db;
    --wc-gray-500:#9ca3af;
    --wc-gray-100:#262626;
    --wc-code-bg:#161b22;
    --wc-code-text:#c9d1d9;
  }
}

/* TOGGLE BUTTON -------------------------------------------------------- */
#chat-toggle{
  position:fixed;bottom:24px;right:24px;
  z-index:1060;
  display:inline-grid;place-items:center;
  width:110px;height:110px;
  background:none;box-shadow:none;cursor:pointer;
  transition:transform var(--wc-dur-fast) var(--wc-ease-spring);
}
#chat-toggle img{
  width:100%;height:100%;object-fit:contain;
  pointer-events:none;
}
#chat-toggle:hover{transform:translateY(-4px) scale(1.04);}
#chat-toggle:active{transform:scale(.93);}
#chat-toggle.active{
  background:linear-gradient(145deg,var(--wc-primary-500),var(--wc-primary-700));
  border-radius:var(--wc-radius-full);
  box-shadow:0 4px 14px rgba(0,0,0,.25);
}

/* PULSE decor disabilitato (solo img pura)                               */

/* WIDGET SHELL --------------------------------------------------------- */
#chat-widget{
  position:fixed;bottom:110px;right:20px;
  width:min(92vw,420px);height:72vh;min-height:480px;
  display:flex;flex-direction:column;
  border-radius:var(--wc-radius-lg);
  backdrop-filter:saturate(160%) blur(var(--wc-glass-blur));
  background:rgba(255,255,255,.65);
  box-shadow:0 12px 32px rgba(0,0,0,.35);
  overflow:hidden;
  transform:translateY(40px) scale(.95);
  opacity:0;pointer-events:none;
  transition:transform var(--wc-dur-med) var(--wc-ease-spring),
             opacity var(--wc-dur-med) ease-out;
  z-index:1050;
}
#chat-widget.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto;}
@media(prefers-color-scheme:dark){
  #chat-widget{background:rgba(30,30,30,.55);box-shadow:0 12px 28px rgba(0,0,0,.75);}
}

/* HEADER --------------------------------------------------------------- */
#chat-header{
  position:relative;padding:.9rem 3.5rem;
  font-weight:700;font-size:1.05rem;
  color:var(--wc-gray-900);text-align:center;
  background:linear-gradient(135deg,var(--wc-primary-400) 0%,var(--wc-primary-600) 100%);
  user-select:none;
}
#chat-close,#chat-restart{
  position:absolute;top:50%;transform:translateY(-50%);
  width:28px;height:28px;display:grid;place-items:center;
  font-size:1.15rem;border-radius:var(--wc-radius-full);
  background:rgba(255,255,255,.35);color:var(--wc-gray-900);cursor:pointer;
  transition:background var(--wc-dur-fast) ease-out,transform var(--wc-dur-fast) var(--wc-ease-spring);
}
#chat-close{right:14px}
#chat-restart{left:14px}
#chat-close:hover,#chat-restart:hover{background:rgba(255,255,255,.55);transform:scale(1.12);}
#chat-close:active,#chat-restart:active{transform:scale(.9);}

/* CHAT BOX ------------------------------------------------------------- */
#chat-box{
  flex:1;display:flex;flex-direction:column;gap:1rem;
  padding:1.2rem 1.4rem;overflow-y:auto;scroll-behavior:smooth;
}
#chat-box::-webkit-scrollbar{width:8px}
#chat-box::-webkit-scrollbar-thumb{background:var(--wc-primary-300);border-radius:4px;opacity:.3;}
#chat-box:hover::-webkit-scrollbar-thumb{background:var(--wc-primary-400);}

/* MESSAGES ------------------------------------------------------------- */
.message{max-width:84%;padding:.75rem 1.1rem;border-radius:1.2rem;
  font-size:.95rem;line-height:1.45;
  animation:fadeIn .25s ease-out both;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.user{align-self:flex-end;color:#fff;
  background:linear-gradient(140deg,var(--wc-primary-500) 0%,var(--wc-primary-700) 100%);
  box-shadow:0 2px 6px rgba(0,0,0,.25);white-space:pre-line;}
.bot{align-self:flex-start;background:rgba(255,255,255,.9);
  color:var(--wc-gray-700);backdrop-filter:blur(6px);border:1px solid rgba(0,0,0,.05);}
@media(prefers-color-scheme:dark){.bot{background:rgba(40,40,40,.8);color:var(--wc-gray-500);}}

/* Markdown tweaks */
.bot ul,.bot ol{margin:.5rem 0 .5rem 1.2rem;padding-left:.4rem}
.bot strong{font-weight:700}
.bot em{font-style:italic}

/* TYPING INDICATOR ----------------------------------------------------- */
.typing{align-self:flex-start;display:inline-flex;gap:4px;padding:.6rem 1rem;
  background:rgba(255,255,255,.85);border-radius:1.2rem;box-shadow:inset 0 1px 2px rgba(0,0,0,.06);}
.typing span{display:block;width:8px;height:8px;border-radius:50%;
  background:var(--wc-primary-500);opacity:.4;animation:blink 1.2s infinite;}
.typing span:nth-child(2){animation-delay:.15s}
.typing span:nth-child(3){animation-delay:.3s}
@keyframes blink{0%,100%{opacity:.25}50%{opacity:1}}

/* PROMPT CHIPS --------------------------------------------------------- */
#chat-prompts{display:flex;flex-wrap:wrap;gap:8px;padding:.85rem 1.2rem;
  background:rgba(255,255,255,.65);backdrop-filter:blur(12px);
  border-top:1px solid rgba(0,0,0,.05);}
.prompt{padding:.5rem 1rem;font-size:.9rem;background:var(--wc-gray-100);
  border-radius:var(--wc-radius-full);cursor:pointer;
  transition:background var(--wc-dur-fast) ease-out,color var(--wc-dur-fast) ease-out,transform var(--wc-dur-fast) var(--wc-ease-spring);}
.prompt:hover{background:var(--wc-primary-200);color:var(--wc-gray-900);transform:translateY(-2px);}
@media(prefers-color-scheme:dark){.prompt{background:#333;color:#ddd}.prompt:hover{background:var(--wc-primary-600);color:#fff;}}

/* INPUT AREA ----------------------------------------------------------- */
#chat-form{display:flex;border-top:1px solid rgba(0,0,0,.05);}
#chat-input{flex:1;border:none;padding:1rem;font-size:1rem;background:transparent;color:var(--wc-gray-900);}
#chat-input::placeholder{color:var(--wc-gray-500)}
#chat-send{border:none;display:grid;place-items:center;padding:0 1.2rem;font-size:1.35rem;
  background:var(--wc-primary-500);color:#fff;cursor:pointer;
  transition:background var(--wc-dur-fast) ease-in-out;}
#chat-send:hover{background:var(--wc-primary-600)}
#chat-send:active{background:var(--wc-primary-700)}

/* CODE BLOCK ----------------------------------------------------------- */
.code-block{background:var(--wc-code-bg);color:var(--wc-code-text);
  border:1px solid rgba(255,255,255,.1);border-radius:8px;
  padding:.9rem 1rem;font-family:\"JetBrains Mono\",Consolas,monospace;
  font-size:.85rem;white-space:pre-wrap;overflow-x:auto;}
.code-block::-webkit-scrollbar{height:6px}
.code-block::-webkit-scrollbar-thumb{background:#444}

/* DISCLAIMER ----------------------------------------------------------- */
#chat-disclaimer{font-size:.72rem;text-align:center;padding:.55rem 1rem;
  color:var(--wc-gray-500);background:rgba(255,255,255,.55);
  backdrop-filter:blur(10px);border-top:1px solid rgba(0,0,0,.05);}
@media(prefers-color-scheme:dark){#chat-disclaimer{background:rgba(35,35,35,.6);color:var(--wc-gray-700);}}

/* MOTION SAFE ---------------------------------------------------------- */
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:.01ms!important;animation-iteration-count:1!important;transition-duration:.01ms!important;scroll-behavior:auto!important}
}
</style>
</head>
<body>

<!-- FAB ------------------------------------------------------------------>
<div id="chat-toggle">
  <img src="icon.png" alt="Chat">
</div>

<!-- Widget ------------------------------------------------------------- -->
<div id="chat-widget">
  <div id="chat-header">Hai bisogno di aiuto?
    <div id="chat-restart" title="Riavvia">⟳</div>
    <div id="chat-close"   title="Chiudi">×</div>
  </div>

  <div id="chat-box"></div>

  <div id="chat-prompts">
    <div class="prompt">Quanto mi servirà per andare in pensione?</div>
    <div class="prompt">Cos'è la pensione integrativa?</div>
    <div class="prompt">Quando potrò andare in pensione?</div>
    <div class="prompt">Come funziona il riscatto della laurea?</div>
  </div>

  <form id="chat-form">
    <input id="chat-input" type="text" placeholder="Scrivi qui…" autocomplete="off" required>
    <button id="chat-send" type="submit">➤</button>
  </form>

  <div id="chat-disclaimer">
    Beta: l’assistente potrebbe contenere imprecisioni. Verifica sempre le informazioni importanti.
  </div>
</div>

<!-- JavaScript --------------------------------------------------------- -->
<script>
/* — Welpy Chat – Inline JS v2 — */
window.addEventListener('DOMContentLoaded', () => {
  /* Marked già configurato nello <head> */

  /* DOM -------------------------------------------------- */
  const $ = q => document.querySelector(q);
  const widget   = $('#chat-widget'),
        toggle   = $('#chat-toggle'),
        closeBtn = $('#chat-close'),
        restartBtn = $('#chat-restart'),
        box   = $('#chat-box'),
        form  = $('#chat-form'),
        input = $('#chat-input'),
        promptBox = $('#chat-prompts'),
        prompts   = document.querySelectorAll('.prompt');

  let threadId = null, firstMsg = false;

  /* UI helpers ------------------------------------------ */
  function appendMessage(txt, sender){
    const m = document.createElement('div');
    m.className = `message ${sender}`;
    m.innerHTML = sender === 'bot' ? marked.parse(txt) : txt;
    box.appendChild(m);
    box.scrollTop = box.scrollHeight;
  }
  function showTyping(){
    const t = document.createElement('div');
    t.className = 'typing'; t.id = 'typing-indicator';
    for (let i = 1; i <= 3; i++){
      const s = document.createElement('span');
      s.textContent = '●'; s.style.setProperty('--i', i);
      t.appendChild(s);
    }
    box.appendChild(t); box.scrollTop = box.scrollHeight;
  }
  const removeTyping = () => document.getElementById('typing-indicator')?.remove();

  /* Toggle widget --------------------------------------- */
  function openWidget(){
    widget.classList.add('open');
    toggle.classList.add('active');
  }
  function closeWidget(){
    widget.classList.remove('open');
    toggle.classList.remove('active');
  }
  toggle.onclick   = () => widget.classList.contains('open') ? closeWidget() : openWidget();
  closeBtn.onclick = closeWidget;
  restartBtn.onclick = () => {
    threadId = null; firstMsg = false; box.innerHTML = '';
    promptBox.style.display = 'flex';
  };

  /* Send ------------------------------------------------ */
  async function sendMessage(txt){
    appendMessage(txt,'user'); input.value='';
    if(!firstMsg){ firstMsg = true; promptBox.style.display = 'none'; }
    showTyping();
    try{
      const res = await fetch('https://welpy-1.onrender.com/chat',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ message:txt, thread_id:threadId })
      });
      const data = await res.json(); threadId = data.thread_id;
      const raw   = typeof data.response === 'string'
                      ? data.response
                      : JSON.stringify(data.response,null,2);
      const clean = raw.replace(/^```(?:markdown)?\\n?/i,'').replace(/```$/,'');
      removeTyping(); appendMessage(clean,'bot');
    }catch{
      removeTyping(); appendMessage('Errore di connessione. Riprova più tardi.','bot');
    }
  }
  form.onsubmit = e => { e.preventDefault(); const v = input.value.trim(); if(v) sendMessage(v); };
  prompts.forEach(p => p.onclick = () => sendMessage(p.textContent));
});
</script>
</body>
</html>
